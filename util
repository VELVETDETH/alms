#!/bin/sh

host=frogger.ccs.neu.edu
remote=public_html/pubs/affine-contracts

if [ -z "$1" ]; then
  set showVersion
fi

while [ -n "$1" ]; do
  cmd="$1"
  shift
  case "$cmd" in
    release)
      ver="$1"; shift
      set version "$ver" ci "version bump: $ver" dist send edit link $@
      ;;
    dist)
      make dist
      ;;
    send)
      scp -p affine-contracts*.tar.gz $host:$remote/
      ;;
    link)
      ssh $host "cd $remote;
                 rm affine-contracts.tar.gz;
                 ln -s \"\`ls affine-contracts-*.tar.gz | tail -1\`\" affine-contracts.tar.gz"
      ;;
    edit)
      ssh $host -t vim $remote/index.html
      ;;
    mv)
      src="$1"; shift
      dst="$1"; shift
      git mv "$src" "$dst" &&
      mv "$dst" "$src" &&
      svn mv "$src" "$dst"
      ;;
    ci)
      msg="$1"; shift
      git ca -m "$msg"
      svn ci -m "$msg"
      ;;
    version)
      version="$1"
      shift
      ex -c "/^VERSION *=/s/=.*/= $version/|:wq" Makefile
      ex -c "/^Version: /s/\\(: *\\).*/\\1$version/|:wq" affine.cabal
      $0 showVersion
      ;;
    showVersion)
      grep -i '^version' Makefile affine.cabal
      ;;
    *)
      echo "What does '$cmd' mean?" >&2
      exit 1
      ;;
  esac
done
