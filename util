#!/bin/sh

name=alms
host=spelunker.ccs.neu.edu
remote=public_html/pubs/$name

if [ -z "$1" ]; then
  set showVersion
fi

while [ -n "$1" ]; do
  cmd="$1"
  shift
  case "$cmd" in
    release)
      ver="$1"; shift
      set version "$ver" ci "version bump: $ver" tagversion "$ver" \
          clean dist send link $@
      ;;
    hackage)
      ver="$1"; shift
      cabal sdist
      cabal upload -c dist/$name-$ver.tar.gz
      ;;
    clean)
      rm $name*.tar.gz
      ;;
    dist)
      make dist
      ;;
    send)
      scp -p $name*.tar.gz $host:$remote/
      ;;
    link)
      version="`$0 showVersion`"
      ssh $host "cd $remote;
                 DISPLAY='' ex -c '/$name-[0-9.]*[.]tar[.]gz/s/-[0-9.]*[.]tar/-$version.tar/|:wq' index.html;
                 rm $name.tar.gz;
                 ln -s '$name-$version.tar.gz' $name.tar.gz"
      ;;
    edit)
      ssh $host -t vim $remote/index.html
      ;;
    mv)
      src="$1"; shift
      dst="$1"; shift
      git mv "$src" "$dst" &&
      mv "$dst" "$src" &&
      svn mv "$src" "$dst"
      ;;
    ci)
      msg="$1"; shift
      git ca -m "$msg"
      svn ci -m "$msg"
      ;;
    add)
      git add $@
      svn add $@
      set --
      ;;
    tagversion)
      version="$1"
      shift
      git tag "$version"
      ;;
    version)
      version="$1"
      shift
      ex -c "/^VERSION *=/s/=.*/= $version/|:wq" Makefile
      ex -c "/^Version: /s/\\(: *\\).*/\\1$version/|:wq" $name.cabal
      $0 showVersion
      ;;
    showVersion)
      awk '$0 ~ /^VERSION *= / { print $3 }' Makefile
      ;;
    *)
      echo "What does '$cmd' mean?" >&2
      exit 1
      ;;
  esac
done
