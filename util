#!/bin/sh

host=spelunker.ccs.neu.edu
remote=public_html/pubs/affine-contracts

if [ -z "$1" ]; then
  set showVersion
fi

while [ -n "$1" ]; do
  cmd="$1"
  shift
  case "$cmd" in
    release)
      ver="$1"; shift
      set version "$ver" ci "version bump: $ver" clean dist send link $@
      ;;
    clean)
      rm affine-contracts*.tar.gz
      ;;
    dist)
      make dist
      ;;
    send)
      scp -p affine-contracts*.tar.gz $host:$remote/
      ;;
    link)
      version="`$0 showVersion`"
      ssh $host "cd $remote;
                 DISPLAY='' ex -c '/affine-contracts-[0-9.]*\.tar\.gz/s/-[0-9.]*\.tar/-$version.tar/|:wq';
                 rm affine-contracts.tar.gz;
                 ln -s 'affine-contracts-$version.tar.gz' affine-contracts.tar.gz"
      ;;
    edit)
      ssh $host -t vim $remote/index.html
      ;;
    mv)
      src="$1"; shift
      dst="$1"; shift
      git mv "$src" "$dst" &&
      mv "$dst" "$src" &&
      svn mv "$src" "$dst"
      ;;
    ci)
      msg="$1"; shift
      git ca -m "$msg"
      svn ci -m "$msg"
      ;;
    version)
      version="$1"
      shift
      ex -c "/^VERSION *=/s/=.*/= $version/|:wq" Makefile
      ex -c "/^Version: /s/\\(: *\\).*/\\1$version/|:wq" affine.cabal
      $0 showVersion
      ;;
    showVersion)
      awk '$0 ~ /^VERSION *= / { print $3 }' Makefile
      ;;
    *)
      echo "What does '$cmd' mean?" >&2
      exit 1
      ;;
  esac
done
